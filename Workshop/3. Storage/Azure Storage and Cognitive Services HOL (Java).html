<!DOCTYPE html>
<html>
<head>
<title>Azure Storage and Cognitive Services HOL (Java)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
<style type="text/css">
.highlight  { background: #ffffff; }
.highlight .c { color: #999988; font-style: italic } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */
.pl-c {
    color: #969896;
}

.pl-c1,.pl-mdh,.pl-mm,.pl-mp,.pl-mr,.pl-s1 .pl-v,.pl-s3,.pl-sc,.pl-sv {
    color: #0086b3;
}

.pl-e,.pl-en {
    color: #795da3;
}

.pl-s1 .pl-s2,.pl-smi,.pl-smp,.pl-stj,.pl-vo,.pl-vpf {
    color: #333;
}

.pl-ent {
    color: #63a35c;
}

.pl-k,.pl-s,.pl-st {
    color: #a71d5d;
}

.pl-pds,.pl-s1,.pl-s1 .pl-pse .pl-s2,.pl-sr,.pl-sr .pl-cce,.pl-sr .pl-sra,.pl-sr .pl-sre,.pl-src,.pl-v {
    color: #df5000;
}

.pl-id {
    color: #b52a1d;
}

.pl-ii {
    background-color: #b52a1d;
    color: #f8f8f8;
}

.pl-sr .pl-cce {
    color: #63a35c;
    font-weight: bold;
}

.pl-ml {
    color: #693a17;
}

.pl-mh,.pl-mh .pl-en,.pl-ms {
    color: #1d3e81;
    font-weight: bold;
}

.pl-mq {
    color: #008080;
}

.pl-mi {
    color: #333;
    font-style: italic;
}

.pl-mb {
    color: #333;
    font-weight: bold;
}

.pl-md,.pl-mdhf {
    background-color: #ffecec;
    color: #bd2c00;
}

.pl-mdht,.pl-mi1 {
    background-color: #eaffea;
    color: #55a532;
}

.pl-mdr {
    color: #795da3;
    font-weight: bold;
}

.pl-mo {
    color: #1d3e81;
}
.task-list {
padding-left:10px;
margin-bottom:0;
}

.task-list li {
    margin-left: 20px;
}

.task-list-item {
list-style-type:none;
padding-left:10px;
}

.task-list-item label {
font-weight:400;
}

.task-list-item.enabled label {
cursor:pointer;
}

.task-list-item+.task-list-item {
margin-top:3px;
}

.task-list-item-checkbox {
display:inline-block;
margin-left:-20px;
margin-right:3px;
vertical-align:1px;
}
</style>
</head>
<body>
<p><a name="HOLTitle"></a></p>
<h1>Azure Storage and Cognitive Services</h1>
<hr>
<p><a name="Overview"></a></p>
<h2>Overview</h2>
<p>Microsoft Azure Storage is a set of services that allows you to store large volumes of data in a cost-effective manner and in a way that makes the data readily and reliably available to services and applications that consume it. Data committed to Azure Storage can be stored in blobs, tables, queues, or files. <a href="http://azure.microsoft.com/en-us/services/storage/blobs/" rel="nofollow">Azure blobs</a> are ideal for storing images, videos, and other types of data, and are frequently used to provide input to and capture output from other Azure services such as <a href="http://azure.microsoft.com/en-us/services/stream-analytics/" rel="nofollow">Azure Stream Analytics</a>. <a href="http://azure.microsoft.com/en-us/services/storage/tables/" rel="nofollow">Azure tables</a> provide NoSQL storage for semi-structured data. <a href="http://azure.microsoft.com/en-us/services/storage/queues/" rel="nofollow">Azure queues</a> support queued message transfers between applications (or parts of applications) and can be used to make applications more scalable and robust by loosely coupling them together. Finally, <a href="http://azure.microsoft.com/en-us/services/storage/files" rel="nofollow">Azure Files</a> use the Server Message Block (SMB) protocol to share files through the cloud and access storage as network drives.</p>
<p>Data stored in Microsoft Azure Storage can be accessed over HTTP or HTTPS using straightforward REST APIs, or it can be accessed using rich client libraries available for many popular languages and platforms, including .NET, Java, Android, Node.js, PHP, Ruby, and Python. The <a href="https://portal.azure.com" rel="nofollow">Azure Portal</a> includes features for working with Azure Storage, but richer functionality is available from third-party tools, many of which are free and some of which work cross-platform.</p>
<p>In this lab, you will use Eclipse to write a Java Web site that accepts images uploaded by users and stores the images in Azure blob storage. You will learn how to read and write blobs in Java, and how to use blob metadata to attach additional information to the blobs you create. You will also get first-hand experience using <a href="https://www.microsoft.com/cognitive-services/" rel="nofollow">Microsoft Cognitive Services</a>, a set of intelligence APIs for building smart applications. Specifically, you'll submit each image uploaded by the user to Cognitive Services' <a href="https://www.microsoft.com/cognitive-services/en-us/computer-vision-api" rel="nofollow">Computer Vision API</a> to generate a caption for the image as well as search metadata describing the contents of the image. And you will discover how easy it is to deploy apps to the cloud using Eclipse and the Azure Toolkit for Eclipse.</p>
<p><a name="Objectives"></a></p>
<h3>Objectives</h3>
<p>In this hands-on lab, you will learn how to:</p>
<ul>
<li>Create a storage account and storage containers using the Azure Portal</li>
<li>Create a Web app in Eclipse and deploy it to Azure</li>
<li>Read and write blobs and attach metadata to them</li>
<li>Use the Computer Vision API to extract information from images</li>
<li>Use the cross-platform <a href="http://storageexplorer.com/" rel="nofollow">Microsoft Azure Storage Explorer</a> to work with Azure Storage</li>
</ul>
<p><a name="Prerequisites"></a></p>
<h3>Prerequisites</h3>
<p>The following are required to complete this hands-on lab:</p>
<ul>
<li>An active Microsoft Azure subscription. If you don't have one, <a href="http://aka.ms/WATK-FreeTrial" rel="nofollow">sign up for a free trial</a>.</li>
<li><a href="http://storageexplorer.com/" rel="nofollow">Microsoft Azure Storage Explorer</a></li>
<li><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" rel="nofollow">Java SE Development Kit</a></li>
<li><a href="https://www.eclipse.org/downloads/" rel="nofollow">Eclipse</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/azure-toolkit-for-eclipse" rel="nofollow">Azure Toolkit for Eclipse</a></li>
</ul>
<p><a name="Resources"></a></p>
<h3>Resources</h3>
<p><a href="https://a4r.blob.core.windows.net/public/cs-storage-resources.zip" rel="nofollow">Click here</a> to download a zip file containing the resources used in this lab. Copy the contents of the zip file into a folder on your hard disk.</p>
<hr>
<p><a name="Exercises"></a></p>
<h2>Exercises</h2>
<p>This hands-on lab includes the following exercises:</p>
<ul>
<li><a href="#Exercise1">Exercise 1: Create a storage account</a></li>
<li><a href="#Exercise2">Exercise 2: Run the Microsoft Azure Storage Explorer</a></li>
<li><a href="#Exercise3">Exercise 3: Get a subscription key for the Computer Vision API</a></li>
<li><a href="#Exercise4">Exercise 4: Set up Java and Eclipse</a></li>
<li><a href="#Exercise5">Exercise 5: Create a photo-upload app</a></li>
<li><a href="#Exercise6">Exercise 6: Test the app locally</a></li>
<li><a href="#Exercise7">Exercise 7: Deploy the app to Azure</a></li>
</ul>
<p><a name="Exercise1"></a></p>
<p>Estimated time to complete this lab: <strong>60</strong> minutes.</p>
<hr>
<p><a name="Exercise1"></a></p>
<h2>Exercise 1: Create a storage account</h2>
<p>The <a href="https://portal.azure.com" rel="nofollow">Azure Portal</a> allows you to perform basic storage operations such as creating storage accounts, creating containers, uploading and downloading blobs, and managing access keys. In this exercise, you will use the portal to create a storage account. Then you'll create a pair of containers: one to store images uploaded by the user, and another to store image thumbnails generated from the uploaded images.</p>
<ol>
<li>
<p>Open the <a href="https://portal.azure.com" rel="nofollow">Azure Portal</a> in your browser. If you are asked to log in, do so using your Microsoft account.</p>
</li>
<li>
<p>To create a storage account, click <strong>+ New</strong> in the ribbon on the left. Then click <strong>Storage</strong>, followed by <strong>Storage account</strong>.</p>
<p><a href="Images/new-storage-account.png" target="_blank"><img src="Images/new-storage-account.png" alt="Creating a storage account" style="max-width:100%;"></a></p>
<p><em>Creating a storage account</em></p>
</li>
<li>
<p>In the ensuing "Create storage account" blade, enter a name for the new storage account in <strong>Name</strong> field. The name is important, because it forms one part of the URL through which blobs created under this account are accessed.</p>
<blockquote>
<p>Storage account names can be 3 to 24 characters in length and can only contain numbers and lowercase letters. In addition, the name you enter must be unique within Azure. If someone else has chosen the same name, you'll be notified that the name isn't available with a red exclamation mark in the <strong>Name</strong> field.</p>
</blockquote>
<p>Once you have a name that Azure will accept, make sure <strong>Resource manager</strong> is selected as the deployment model and <strong>General purpose</strong> is selected as the account type. Then select <strong>Create new</strong> under <strong>Resource group</strong> and enter "IntellipixResources" as the resource-group name. Select the <strong>Location</strong> nearest you, and finish up by clicking the <strong>Create</strong> button at the bottom of the blade to create the new storage account.</p>
<p><a href="Images/create-storage-account.png" target="_blank"><img src="Images/create-storage-account.png" alt="Specifying parameters for a new storage account" style="max-width:100%;"></a></p>
<p><em>Specifying parameters for a new storage account</em></p>
</li>
<li>
<p>Click <strong>Resource groups</strong> in the ribbon on the left. Then click the "IntellipixResources" resource group.</p>
<p><a href="Images/open-resource-group.png" target="_blank"><img src="Images/open-resource-group.png" alt="Opening the resource group" style="max-width:100%;"></a></p>
<p><em>Opening the resource group</em></p>
</li>
<li>
<p>In the blade that opens for the resource group, click the storage account you just created. If the storage account isn't there yet, you can click <strong>Refresh</strong> at the top of the blade until it appears.</p>
<p><a href="Images/open-storage-account.png" target="_blank"><img src="Images/open-storage-account.png" alt="Opening the new storage account" style="max-width:100%;"></a></p>
<p><em>Opening the new storage account</em></p>
</li>
<li>
<p>In the blade for the storage account, click <strong>Blobs</strong> to view a list of containers associated with this account.</p>
<p><a href="Images/view-containers.png" target="_blank"><img src="Images/view-containers.png" alt="Viewing blob containers" style="max-width:100%;"></a></p>
<p><em>Viewing blob containers</em></p>
</li>
<li>
<p>The storage account currently has no containers. Before you can create a blob, you must create a container to store it in. Click <strong>+ Container</strong> to create a new container. Type "photos" (without quotation marks) into the <strong>Name</strong> field and select <strong>Blob</strong> as the <strong>Public access level</strong>. Then click <strong>OK</strong> to create a container named "photos."</p>
<blockquote>
<p>By default, containers and their contents are private. Selecting <strong>Blob</strong> as the access level makes the blobs in the "photos" container publicly accessible, but doesn't make the container itself public. This is what you want since the images stored in the "photos" container will be linked to from a Web app.</p>
</blockquote>
<p><a href="Images/create-photos-container.png" target="_blank"><img src="Images/create-photos-container.png" alt="Creating a &quot;photos&quot; container" style="max-width:100%;"></a></p>
<p><em>Creating a "photos" container</em></p>
</li>
<li>
<p>Repeat the previous step to create a container named "thumbnails," once more ensuring that the container's <strong>Public access level</strong> is set to <strong>Blob</strong>.</p>
</li>
<li>
<p>Confirm that both containers appear in the list of containers for this storage account, and that the names are spelled correctly.</p>
<p><a href="Images/new-containers.png" target="_blank"><img src="Images/new-containers.png" alt="The new containers" style="max-width:100%;"></a></p>
<p><em>The new containers</em></p>
</li>
<li>
<p>Close the "Blob service" blade. Click <strong>Access keys</strong> in the menu on the left side of the storage-account blade, and then click the <strong>Copy</strong> button next to <strong>KEY</strong> for <strong>key1</strong>. Paste this access key into your favorite text editor for later use.</p>
<p><a href="Images/copy-storage-account-access-key.png" target="_blank"><img src="Images/copy-storage-account-access-key.png" alt="Copying the access key" style="max-width:100%;"></a></p>
<p><em>Copying the access key</em></p>
</li>
</ol>
<p>You have now created a storage account to hold images uploaded to the app you're going to build, and containers to store the images in. Note that you <em>could</em> create these containers from within the app. Whether to create them programmatically or create them as part of the provisioning process is a choice that's left up to app developers.</p>
<p><a name="Exercise2"></a></p>
<h2>Exercise 2: Run the Microsoft Azure Storage Explorer</h2>
<p>The <a href="http://storageexplorer.com/" rel="nofollow">Microsoft Azure Storage Explorer</a> is a free tool that provides a graphical interface for working with Azure Storage on PCs running Windows, macOS, and Linux. It provides most of the same functionality as the Azure Portal. It also offers features the portal does not, such as the ability to view blob metadata. In this exercise, you will use the Microsoft Azure Storage Explorer to view the containers you created in Exercise 1.</p>
<ol>
<li>
<p>If you haven't installed Storage Explorer or would like to make sure you're running the latest version, go to <a href="http://storageexplorer.com/" rel="nofollow">http://storageexplorer.com/</a> and download and install it.</p>
</li>
<li>
<p>Start Storage Explorer. If you are asked to log in, do so using your Microsoft account â€” the same one that you used to log in to the Azure Portal. If you don't see the storage account created in the previous exercise in Storage Explorer's left pane, click the <strong>Manage Accounts</strong> button highlighted below and ensure that your Microsoft account <em>and</em> the subscription used to create the storage account have been added to Storage Explorer.</p>
<p><a href="Images/add-account.png" target="_blank"><img src="Images/add-account.png" alt="Managing accounts in Storage Explorer" style="max-width:100%;"></a></p>
<p><em>Managing accounts in Storage Explorer</em></p>
</li>
<li>
<p>Click the small arrow next to the storage account you created in Exercise 1 to display its contents, and then click the arrow next to <strong>Blob Containers</strong>. Confirm that the containers you created in Exercise 1 appear in the list.</p>
<p><a href="Images/storage-explorer.png" target="_blank"><img src="Images/storage-explorer.png" alt="Viewing blob containers" style="max-width:100%;"></a></p>
<p><em>Viewing blob containers</em></p>
</li>
</ol>
<p>The containers are currently empty, but that will change once your app is deployed and you start uploading photos. Having Storage Explorer installed will make it easy for you to see what your app writes to blob storage.</p>
<p><a name="Exercise3"></a></p>
<h2>Exercise 3: Get a subscription key for the Computer Vision API</h2>
<p><a href="https://www.microsoft.com/cognitive-services/" rel="nofollow">Microsoft Cognitive Services</a> is a set of intelligence APIs that you can call from your apps. Among the more than 25 APIs it offers are the <a href="https://www.microsoft.com/cognitive-services/en-us/computer-vision-api" rel="nofollow">Computer Vision API</a> for distilling actionable information from images, and the <a href="https://www.microsoft.com/cognitive-services/en-us/text-analytics-api" rel="nofollow">Text Analytics API</a> for extracting sentiments and other information from text (for example, Twitter feeds). These APIs make it possible to build smart apps that would have been impossible just a few short years ago. And they're available for you to begin using today.</p>
<p>In this exercise, you will acquire a subscription key allowing you to call the Computer Vision API from your code. You'll use this key in a later exercise to generate captions and search keywords for images uploaded to the Web site.</p>
<ol>
<li>
<p>In the Azure Portal, click <strong>+ New</strong>, followed by <strong>AI + Cognitive Services</strong> and <strong>Computer Vision API</strong>.</p>
<p><a href="Images/new-vision-api.png" target="_blank"><img src="Images/new-vision-api.png" alt="Creating a new Computer Vision API subscription" style="max-width:100%;"></a></p>
<p><em>Creating a new Computer Vision API subscription</em></p>
</li>
<li>
<p>Type "vision-api-key" into the <strong>Name</strong> box and select <strong>F0</strong> as the <strong>Pricing tier</strong>. Select the same <strong>Location</strong> that you selected for the storage account in <a href="#Exercise1">Exercise 1</a>. Under <strong>Resource group</strong>, select <strong>Use existing</strong> and select the "IntellipixResources" resource group. Check the <strong>I confirm</strong> box, and then click <strong>Create</strong>.</p>
<p><a href="Images/create-vision-api.png" target="_blank"><img src="Images/create-vision-api.png" alt="Subcribing to the Computer Vision API" style="max-width:100%;"></a></p>
<p><em>Subcribing to the Computer Vision API</em></p>
</li>
<li>
<p>Return to the blade for the "IntellipixResources" resource group and click the Computer Vision API subscription that you just created.</p>
<p><a href="Images/open-vision-api.png" target="_blank"><img src="Images/open-vision-api.png" alt="Opening the Computer Vision API subscription" style="max-width:100%;"></a></p>
<p><em>Opening the Computer Vision API subscription</em></p>
</li>
<li>
<p>Copy the URL under <strong>Endpoint</strong> into your favorite text editor so you can easily retrieve it later. Then click <strong>Show access keys</strong>.</p>
<p><a href="Images/copy-vision-endpoint.png" target="_blank"><img src="Images/copy-vision-endpoint.png" alt="Viewing the access keys" style="max-width:100%;"></a></p>
<p><em>Viewing the access keys</em></p>
</li>
<li>
<p>Click the <strong>Copy</strong> button to the right of <strong>KEY 1</strong> to copy the access key to the clipboard. Then paste the key into your favorite text editor so you can retrieve it later.</p>
<p><a href="Images/copy-vision-key.png" target="_blank"><img src="Images/copy-vision-key.png" alt="Copying the access key" style="max-width:100%;"></a></p>
<p><em>Copying the access key</em></p>
</li>
</ol>
<p>The access key that you just copied will be included in each HTTPS request sent to the Computer Vision API so Azure can verify that the caller is authorized. You should protect this access key the same way you protect access keys for storage accounts and other Azure resources.</p>
<p><a name="Exercise4"></a></p>
<h2>Exercise 4: Set up Java and Eclipse</h2>
<p><a href="https://eclipse.org/" rel="nofollow">Eclipse</a> has long been one of the most popular IDEs for developing Java apps. A rich ecosystem of components and plug-ins has grown up around it, making it a very capable IDE for doing all things Java. <a href="https://azure.microsoft.com/en-us/develop/java/" rel="nofollow">Microsoft's Java group</a> has has provided tools for integrating Eclipse with Azure using the <a href="https://docs.microsoft.com/en-us/azure/azure-toolkit-for-eclipse" rel="nofollow">Azure Toolkit for Eclipse</a>. It comes with the ability to deploy apps to Azure either as Azure Web Apps or in Docker containers, and it contains tools for managing Azure resources such as Azure Storage, Azure Web Apps, Redis Cache, HDInsight, and Azure virtual machines.</p>
<p>In this exercise, you will set up Java, Eclipse, and the Azure Toolkit for Eclipse.</p>
<ol>
<li>
<p>If you don't already have the Java Development Kit (JDK) installed, go to <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" rel="nofollow">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a> and click the <strong>JDK Download</strong> button.</p>
<p><a href="Images/java-download-java.png" target="_blank"><img src="Images/java-download-java.png" alt="Downloading the JDK" style="max-width:100%;"></a></p>
<p><em>Downloading the JDK</em></p>
</li>
<li>
<p>Click <strong>Accept License Agreement</strong>, and then click the installer that matches your system. The installers are self-contained and will install and configure everything you need to run and compile Java. Once the installer downloads, run it and follow the prompts to install the JDK.</p>
<p><a href="Images/java-download-java-2.png" target="_blank"><img src="Images/java-download-java-2.png" alt="Installing the JDK" style="max-width:100%;"></a></p>
<p><em>Installing the JDK</em></p>
</li>
<li>
<p>If Eclipse is not installed on your system. go to <a href="https://www.eclipse.org/downloads/" rel="nofollow">https://www.eclipse.org/downloads/</a> and click the <strong>Download</strong> button. Then click the <strong>Download</strong> button that appears on the next page to download the Eclipse installer.</p>
<p><a href="Images/java-download-eclipse.png" target="_blank"><img src="Images/java-download-eclipse.png" alt="Downloading Eclipse" style="max-width:100%;"></a></p>
<p><em>Downloading Eclipse</em></p>
</li>
<li>
<p>When the download completes, launch the installer. When prompted to choose an Eclipse configuration, select <strong>Eclipse IDE for Java EE Developers</strong>. Then click the <strong>Install</strong> button and follow the prompts to install Eclipse.</p>
<p><a href="Images/java-eclipse-installer.png" target="_blank"><img src="Images/java-eclipse-installer.png" alt="Specifying the Eclipse configuration" style="max-width:100%;"></a></p>
<p><em>Specifying the Eclipse configuration</em></p>
</li>
<li>
<p>Launch Eclipse. When prompted to create a workspace, enter "intellipix" as the workspace folder name.</p>
<p><a href="Images/java-create-workspace.png" target="_blank"><img src="Images/java-create-workspace.png" alt="Creating a workspace" style="max-width:100%;"></a></p>
<p><em>Creating a workspace</em></p>
</li>
<li>
<p>Select <strong>Eclipse Marketplace</strong> from Eclipse's <strong>Help</strong> menu. Type "azure toolkit" into the <strong>Find</strong> box and click <strong>Go</strong>. Then click the <strong>Install</strong> button under <strong>Azure Toolkit for Eclipse</strong> to install the toolkit. Accept any licenses presented to you and allow Eclipse to restart if needed.</p>
<p><a href="Images/java-install-azure-toolkit.png" target="_blank"><img src="Images/java-install-azure-toolkit.png" alt="Installing the Azure Toolkit for Eclipse" style="max-width:100%;"></a></p>
<p><em>Installing the Azure Toolkit for Eclipse</em></p>
</li>
<li>
<p>Select <strong>Preferences</strong> from Eclipse's <strong>Window</strong> menu. Click <strong>Maven</strong> in the preferences list on the left and uncheck the <strong>Do not automatically update dependencies from remote repositories</strong> box. Then click <strong>OK</strong>.</p>
<p><a href="Images/java-change-maven-updates.png" target="_blank"><img src="Images/java-change-maven-updates.png" alt="Updating Maven settings" style="max-width:100%;"></a></p>
<p><em>Updating Maven settings</em></p>
</li>
</ol>
<p>Eclipse is now configured for Azure development. The next step is to use it to begin a new project and create a Web app that can be tested locally and then deployed to Azure.</p>
<p><a name="Exercise5"></a></p>
<h2>Exercise 5: Create a photo-upload app</h2>
<p>In this exercise, you will create a new Web app in Eclipse and add code to upload images, write them to blob storage, display them in a Web page, generate captions and keywords using the Computer Vision API, and perform keyword searches on uploaded images. The app will be named Intellipix (for "Intelligent Pictures") and will be accessed through your browser. The server-side code will be written in Java and will utilize <a href="https://en.wikipedia.org/wiki/Java_servlet" rel="nofollow">Java servlets</a>. The client side will be implemented in HTML, CSS, and JavaScript.</p>
<ol>
<li>
<p>Use the <strong>File</strong> &gt; <strong>New</strong> &gt; <strong>Dynamic Web Project</strong> command to create a new project. Set <strong>Project name</strong> to "Intellipix," and then click the <strong>New Runtime...</strong> button.</p>
<p><a href="Images/java-new-project-1.png" target="_blank"><img src="Images/java-new-project-1.png" alt="Creating a new project" style="max-width:100%;"></a></p>
<p><em>Creating a new project</em></p>
</li>
<li>
<p>Select <strong>Apache Tomcat v7.0</strong>. Then check the <strong>Create a new local server</strong> box and click <strong>Next</strong>.</p>
<p><a href="Images/java-new-project-2.png" target="_blank"><img src="Images/java-new-project-2.png" alt="Selecting a runtime" style="max-width:100%;"></a></p>
<p><em>Selecting a runtime</em></p>
</li>
<li>
<p>Click the <strong>Browse...</strong> button and a select a Tomcat installation directory. (Any writable directory will do.) Then click <strong>Download and Install...</strong> to start the Tomcat install. Accept the license agreement presented to you. When installation is complete, click <strong>Finish</strong> in the "New Server Runtime Environment" dialog, followed by <strong>Finish</strong> in the "New Dynamic Web Project" dialog.</p>
<p><a href="Images/java-new-project-3.png" target="_blank"><img src="Images/java-new-project-3.png" alt="Installing Tomcat" style="max-width:100%;"></a></p>
<p><em>Installing Tomcat</em></p>
</li>
<li>
<p>Close the "Welcome" tab in Eclipse to switch to the Java EE view.</p>
</li>
<li>
<p>Right-click (On a Mac, Control-click) the Intellipix project in Project Explorer. Then select <strong>Configure</strong> &gt; <strong>Convert to Maven Project</strong> from the context menu. In the "Create new POM" dialog that ensues, accept the defaults and click <strong>Finish</strong>.</p>
<blockquote>
<p>Maven is a package manager for Java. This action adds a <strong>pom.xml</strong> file to the project which is used to install dependencies from Maven repositories.</p>
</blockquote>
</li>
<li>
<p>Right-click the Intellipix project again, and this time select <strong>Maven</strong> &gt; <strong>Add Dependency</strong>. In the "Add Dependency" dialog, set <strong>Group Id</strong> to "com.microsoft.azure," <strong>Artifact Id</strong> to "azure-storage," and <strong>Version</strong> to "5.1.1." Then click <strong>OK</strong> to add Azure Storage libraries to the project.</p>
<p><a href="Images/java-add-maven-dependency-1.png" target="_blank"><img src="Images/java-add-maven-dependency-1.png" alt="Adding Azure Storage libraries" style="max-width:100%;"></a></p>
<p><em>Adding Azure Storage libraries</em></p>
</li>
<li>
<p>Repeat Step 6, but enter the values shown below into the "Add Dependency" dialog. This adds Java servlet libraries to the project.</p>
<p><a href="Images/java-add-maven-dependency-2.png" target="_blank"><img src="Images/java-add-maven-dependency-2.png" alt="Adding servlet libraries" style="max-width:100%;"></a></p>
<p><em>Adding servlet libraries</em></p>
</li>
<li>
<p>Repeat Step 6, but enter the values shown below into the "Add Dependency" dialog. This adds some common I/O utility libraries to the project.</p>
<p><a href="Images/java-add-maven-dependency-3.png" target="_blank"><img src="Images/java-add-maven-dependency-3.png" alt="Adding I/O utility libraries" style="max-width:100%;"></a></p>
<p><em>Adding I/O utility libraries</em></p>
</li>
<li>
<p>Repeat Step 6 one last time, but enter the values shown below into the "Add Dependency" dialog. This adds JSON libraries to the project. Many of the Azure APIs send and receive data in JSON format.</p>
<p><a href="Images/java-add-maven-dependency-4.png" target="_blank"><img src="Images/java-add-maven-dependency-4.png" alt="Adding JSON libraries" style="max-width:100%;"></a></p>
<p><em>Adding JSON libraries</em></p>
</li>
<li>
<p>Expand the Intellipix project in Project Explorer. Right-click the "src" folder under <strong>Java Resources</strong> and select <strong>New</strong> &gt; <strong>Servlet</strong>.</p>
<p><a href="Images/java-new-servlet.png" target="_blank"><img src="Images/java-new-servlet.png" alt="Adding a servlet" style="max-width:100%;"></a></p>
<p><em>Adding a servlet</em></p>
</li>
<li>
<p>In the "Create Servlet" dialog, set <strong>Java package</strong> to "intellipix" and <strong>Class name</strong> to "Api." Then click <strong>Finish</strong>.</p>
<p><a href="Images/java-create-servlet.png" target="_blank"><img src="Images/java-create-servlet.png" alt="Creating a servlet" style="max-width:100%;"></a></p>
<p><em>Creating a servlet</em></p>
</li>
<li>
<p>Open <strong>Api.java</strong> in the "intellipix" folder created under the "src" folder, and replace its contents with the code below. Then save the modified file.</p>
<div class="highlight highlight-source-java"><pre><span class="pl-k">package</span> <span class="pl-smi">intellipix</span>;

<span class="pl-k">import</span> <span class="pl-smi">java.awt.Graphics2D</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.awt.GraphicsConfiguration</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.awt.GraphicsDevice</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.awt.GraphicsEnvironment</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.awt.geom.AffineTransform</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.awt.image.BufferedImage</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.io.*</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.net.HttpURLConnection</span>;

<span class="pl-k">import</span> <span class="pl-smi">java.net.URL</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.nio.file.Paths</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.util.HashMap</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.util.List</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.util.stream.Collectors</span>;

<span class="pl-k">import</span> <span class="pl-smi">javax.imageio.ImageIO</span>;
<span class="pl-k">import</span> <span class="pl-smi">javax.imageio.stream.ImageOutputStream</span>;
<span class="pl-k">import</span> <span class="pl-smi">javax.servlet.ServletException</span>;
<span class="pl-k">import</span> <span class="pl-smi">javax.servlet.annotation.MultipartConfig</span>;
<span class="pl-k">import</span> <span class="pl-smi">javax.servlet.annotation.WebServlet</span>;
<span class="pl-k">import</span> <span class="pl-smi">javax.servlet.http.*</span>;

<span class="pl-k">import</span> <span class="pl-smi">org.apache.commons.io.IOUtils</span>;
<span class="pl-k">import</span> <span class="pl-smi">org.json.JSONArray</span>;
<span class="pl-k">import</span> <span class="pl-smi">org.json.JSONObject</span>;

<span class="pl-k">import</span> <span class="pl-smi">com.microsoft.azure.storage.*</span>;
<span class="pl-k">import</span> <span class="pl-smi">com.microsoft.azure.storage.blob.*</span>;

<span class="pl-k">@WebServlet</span>(<span class="pl-s"><span class="pl-pds">"</span>/api<span class="pl-pds">"</span></span>)
<span class="pl-k">@MultipartConfig</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Api</span> <span class="pl-k">extends</span> <span class="pl-e">HttpServlet</span> {
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-k">long</span> serialVersionUID <span class="pl-k">=</span> <span class="pl-c1">1L</span>;
    <span class="pl-k">private</span> <span class="pl-smi">String</span> connectionString <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>connection_string<span class="pl-pds">"</span></span>;
    <span class="pl-k">private</span> <span class="pl-smi">String</span> visionAPIKey <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>vision_api_key<span class="pl-pds">"</span></span>;
    <span class="pl-k">private</span> <span class="pl-smi">String</span> visionEndpoint <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>vision_api_endpoint<span class="pl-pds">"</span></span>;
    
    
    <span class="pl-k">public</span> <span class="pl-en">Api</span>() {
        <span class="pl-c1">super</span>();
    }

    <span class="pl-c"><span class="pl-c">//</span> This method handles GET requests for images </span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">doGet</span>(<span class="pl-smi">HttpServletRequest</span> <span class="pl-v">request</span>, <span class="pl-smi">HttpServletResponse</span> <span class="pl-v">response</span>) <span class="pl-k">throws</span> <span class="pl-smi">ServletException</span>, <span class="pl-smi">IOException</span> {
        <span class="pl-smi">CloudBlobContainer</span> images <span class="pl-k">=</span> getContainer(<span class="pl-s"><span class="pl-pds">"</span>photos<span class="pl-pds">"</span></span>);
        response<span class="pl-k">.</span>setContentType(<span class="pl-s"><span class="pl-pds">"</span>application/json<span class="pl-pds">"</span></span>);  
        <span class="pl-smi">PrintWriter</span> out <span class="pl-k">=</span> response<span class="pl-k">.</span>getWriter();

        <span class="pl-c"><span class="pl-c">//</span> look for a search parameter in the query string</span>
        <span class="pl-smi">String</span> search <span class="pl-k">=</span> request<span class="pl-k">.</span>getParameter(<span class="pl-s"><span class="pl-pds">"</span>search<span class="pl-pds">"</span></span>);
        <span class="pl-smi">JSONArray</span> azureImages <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JSONArray</span>();
		
        <span class="pl-c"><span class="pl-c">//</span> get a list of images from Azure Storage</span>
        <span class="pl-k">for</span> (<span class="pl-smi">ListBlobItem</span> photo<span class="pl-k">:</span> images<span class="pl-k">.</span>listBlobs()) {
            <span class="pl-k">boolean</span> match <span class="pl-k">=</span> <span class="pl-c1">false</span>;
            <span class="pl-smi">JSONObject</span> azureImage <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JSONObject</span>();
            <span class="pl-smi">CloudBlob</span> imageBlob <span class="pl-k">=</span> (<span class="pl-smi">CloudBlob</span>)photo;

            <span class="pl-k">try</span> {
                imageBlob<span class="pl-k">.</span>downloadAttributes();
            }
            <span class="pl-k">catch</span> (<span class="pl-smi">StorageException</span> e) {
                e<span class="pl-k">.</span>printStackTrace();
            }
			
            <span class="pl-c"><span class="pl-c">//</span> get the blob URL</span>
            azureImage<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>url<span class="pl-pds">"</span></span>, imageBlob<span class="pl-k">.</span>getUri()<span class="pl-k">.</span>toString()<span class="pl-k">.</span>replace(<span class="pl-s"><span class="pl-pds">"</span>.blob.core.windows.net/photos/<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>.blob.core.windows.net/thumbnails/<span class="pl-pds">"</span></span>));
            azureImage<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>fullUrl<span class="pl-pds">"</span></span>, imageBlob<span class="pl-k">.</span>getUri()<span class="pl-k">.</span>toString());
			
            <span class="pl-k">HashMap&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> metadata <span class="pl-k">=</span> imageBlob<span class="pl-k">.</span>getMetadata();
			
            <span class="pl-k">if</span> (<span class="pl-k">!</span>metadata<span class="pl-k">.</span>isEmpty()) {
                <span class="pl-smi">JSONObject</span> imageMetadata <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JSONObject</span>();

                <span class="pl-c"><span class="pl-c">//</span> get the caption from blob metadata</span>
                <span class="pl-k">if</span> (metadata<span class="pl-k">.</span>containsKey(<span class="pl-s"><span class="pl-pds">"</span>caption<span class="pl-pds">"</span></span>)) {
                    imageMetadata<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>caption<span class="pl-pds">"</span></span>, metadata<span class="pl-k">.</span>get(<span class="pl-s"><span class="pl-pds">"</span>caption<span class="pl-pds">"</span></span>));
                    <span class="pl-k">if</span> (search <span class="pl-k">!=</span> <span class="pl-c1">null</span> <span class="pl-k">&amp;&amp;</span> imageMetadata<span class="pl-k">.</span>getString(<span class="pl-s"><span class="pl-pds">"</span>caption<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>toLowerCase()<span class="pl-k">.</span>contains(search<span class="pl-k">.</span>toLowerCase())) {
                        match <span class="pl-k">=</span> <span class="pl-c1">true</span>;
                    }
                }

                <span class="pl-c"><span class="pl-c">//</span> get tags from blob metadata	</span>
                <span class="pl-k">if</span> (metadata<span class="pl-k">.</span>containsKey(<span class="pl-s"><span class="pl-pds">"</span>tags<span class="pl-pds">"</span></span>)) {
                    <span class="pl-smi">JSONArray</span> tags <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JSONArray</span>(metadata<span class="pl-k">.</span>get(<span class="pl-s"><span class="pl-pds">"</span>tags<span class="pl-pds">"</span></span>));
                    imageMetadata<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>tags<span class="pl-pds">"</span></span>, tags);
                    <span class="pl-k">if</span> (search <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
                        <span class="pl-k">for</span> (<span class="pl-smi">Object</span> tag<span class="pl-k">:</span> imageMetadata<span class="pl-k">.</span>getJSONArray(<span class="pl-s"><span class="pl-pds">"</span>tags<span class="pl-pds">"</span></span>)) {
                            <span class="pl-k">if</span> (((<span class="pl-smi">String</span>)tag)<span class="pl-k">.</span>toLowerCase()<span class="pl-k">.</span>equals(search<span class="pl-k">.</span>toLowerCase())) {match <span class="pl-k">=</span> <span class="pl-c1">true</span>; <span class="pl-k">break</span>;}
                        }								
                    }
                }
						
                azureImage<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>metadata<span class="pl-pds">"</span></span>, imageMetadata);	
				
                <span class="pl-k">if</span> (search <span class="pl-k">!=</span> <span class="pl-c1">null</span> <span class="pl-k">&amp;&amp;</span> match) {
                    azureImages<span class="pl-k">.</span>put(azureImage);				
                }
                <span class="pl-k">else</span> <span class="pl-k">if</span> (search <span class="pl-k">==</span> <span class="pl-c1">null</span>) {
                    azureImages<span class="pl-k">.</span>put(azureImage);	
                }
            }
            <span class="pl-k">else</span> <span class="pl-k">if</span> (search <span class="pl-k">==</span> <span class="pl-c1">null</span>) {
                azureImages<span class="pl-k">.</span>put(azureImage);								
            }
        };
		
        <span class="pl-c"><span class="pl-c">//</span> write the list back as JSON</span>
        out<span class="pl-k">.</span>print(azureImages<span class="pl-k">.</span>toString());
        out<span class="pl-k">.</span>flush();
    }

    <span class="pl-c"><span class="pl-c">//</span> This method handles image uploads</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">doPost</span>(<span class="pl-smi">HttpServletRequest</span> <span class="pl-v">request</span>, <span class="pl-smi">HttpServletResponse</span> <span class="pl-v">response</span>) <span class="pl-k">throws</span> <span class="pl-smi">ServletException</span>, <span class="pl-smi">IOException</span> {
        <span class="pl-c"><span class="pl-c">//</span> parse uploaded content for uploaded files</span>
        <span class="pl-k">List&lt;<span class="pl-smi">Part</span>&gt;</span> fileParts <span class="pl-k">=</span> request<span class="pl-k">.</span>getParts()<span class="pl-k">.</span>stream()<span class="pl-k">.</span>filter(part <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>photos<span class="pl-pds">"</span></span><span class="pl-k">.</span>equals(part<span class="pl-k">.</span>getName()))<span class="pl-k">.</span>collect(<span class="pl-smi">Collectors</span><span class="pl-k">.</span>toList()); <span class="pl-c"><span class="pl-c">//</span> Retrieves &lt;input type="file" name="file" multiple="true"&gt;</span>

        <span class="pl-k">for</span> (<span class="pl-smi">Part</span> filePart <span class="pl-k">:</span> fileParts) {
            <span class="pl-smi">String</span> fileName <span class="pl-k">=</span> <span class="pl-smi">Paths</span><span class="pl-k">.</span>get(getSubmittedFileName(filePart))<span class="pl-k">.</span>getFileName()<span class="pl-k">.</span>toString(); 
            <span class="pl-smi">InputStream</span> fileContent <span class="pl-k">=</span> filePart<span class="pl-k">.</span>getInputStream();
            <span class="pl-k">byte</span>[] imageBuffer <span class="pl-k">=</span> <span class="pl-smi">IOUtils</span><span class="pl-k">.</span>toByteArray(fileContent); <span class="pl-c"><span class="pl-c">//</span> raw byte data for the image</span>
	                
            <span class="pl-c"><span class="pl-c">//</span> create a thumbnail for the uploaded image and convert it into a ByteArrayInputStream</span>
            <span class="pl-smi">ByteArrayInputStream</span> inputStream <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ByteArrayInputStream</span>(imageBuffer);
            <span class="pl-smi">BufferedImage</span> img <span class="pl-k">=</span> <span class="pl-smi">ImageIO</span><span class="pl-k">.</span>read(inputStream);
            <span class="pl-smi">BufferedImage</span> thumbnail <span class="pl-k">=</span> scale (img, <span class="pl-c1">200.0</span> <span class="pl-k">/</span> img<span class="pl-k">.</span>getWidth()); <span class="pl-c"><span class="pl-c">//</span>scale to 200  pixels wide</span>
	        
            <span class="pl-c"><span class="pl-c">//</span> write the thumbnail as a PNG to an input stream</span>
            <span class="pl-smi">ByteArrayOutputStream</span> bytes <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ByteArrayOutputStream</span>();
            <span class="pl-smi">ImageOutputStream</span> thumbnailData <span class="pl-k">=</span> <span class="pl-smi">ImageIO</span><span class="pl-k">.</span>createImageOutputStream(bytes);
            <span class="pl-smi">ImageIO</span><span class="pl-k">.</span>write(thumbnail, <span class="pl-s"><span class="pl-pds">"</span>png<span class="pl-pds">"</span></span>, thumbnailData);
            <span class="pl-smi">ByteArrayInputStream</span> thumbnailContent <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ByteArrayInputStream</span>(bytes<span class="pl-k">.</span>toByteArray()); 

            <span class="pl-c"><span class="pl-c">//</span> upload the original image to Azure Storage</span>
            inputStream <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ByteArrayInputStream</span>(imageBuffer);
            <span class="pl-smi">CloudBlob</span> imgBlob <span class="pl-k">=</span> uploadBlob(<span class="pl-s"><span class="pl-pds">"</span>photos<span class="pl-pds">"</span></span>, fileName, inputStream, <span class="pl-c1">null</span>);
	        
            <span class="pl-k">try</span> {
                <span class="pl-c"><span class="pl-c">//</span> send the image to the Computer Vision API for analysis</span>
                <span class="pl-smi">JSONObject</span> analysis <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JSONObject</span>(analyzeImage(imgBlob<span class="pl-k">.</span>getUri()<span class="pl-k">.</span>toString()));
                <span class="pl-k">HashMap&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> metadata <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">HashMap&lt;<span class="pl-smi">String</span>,<span class="pl-smi">String</span>&gt;</span>();
		        
                <span class="pl-c"><span class="pl-c">//</span> extract analysis data and stores it in blob metadata</span>
                <span class="pl-k">if</span> (analysis<span class="pl-k">.</span>has(<span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span>)) {
                    <span class="pl-k">if</span> (analysis<span class="pl-k">.</span>getJSONObject(<span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>has(<span class="pl-s"><span class="pl-pds">"</span>captions<span class="pl-pds">"</span></span>) <span class="pl-k">&amp;&amp;</span> analysis<span class="pl-k">.</span>getJSONObject(<span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>getJSONArray(<span class="pl-s"><span class="pl-pds">"</span>captions<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>length() <span class="pl-k">!=</span> <span class="pl-c1">0</span>) {
	                    metadata<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>caption<span class="pl-pds">"</span></span>, analysis<span class="pl-k">.</span>getJSONObject(<span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>getJSONArray(<span class="pl-s"><span class="pl-pds">"</span>captions<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>getJSONObject(<span class="pl-c1">0</span>)<span class="pl-k">.</span>getString(<span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>));
                    }
                    <span class="pl-k">else</span> {
                        metadata<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>caption<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Unknown<span class="pl-pds">"</span></span>);
                    }

                    <span class="pl-k">if</span> (analysis<span class="pl-k">.</span>getJSONObject(<span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>has(<span class="pl-s"><span class="pl-pds">"</span>tags<span class="pl-pds">"</span></span>) <span class="pl-k">&amp;&amp;</span> analysis<span class="pl-k">.</span>getJSONObject(<span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>getJSONArray(<span class="pl-s"><span class="pl-pds">"</span>tags<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>length() <span class="pl-k">!=</span> <span class="pl-c1">0</span>) {
                        metadata<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>tags<span class="pl-pds">"</span></span>, analysis<span class="pl-k">.</span>getJSONObject(<span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>getJSONArray(<span class="pl-s"><span class="pl-pds">"</span>tags<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>toString());
                    }
                    <span class="pl-k">else</span> {
                        metadata<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>caption<span class="pl-pds">"</span></span>, <span class="pl-k">new</span> <span class="pl-smi">JSONArray</span>()<span class="pl-k">.</span>toString());
                    }
                }

                imgBlob<span class="pl-k">.</span>setMetadata(metadata);
                imgBlob<span class="pl-k">.</span>uploadMetadata();
		        
                <span class="pl-c"><span class="pl-c">//</span> upload the thumbnail to Azure Storage</span>
                uploadBlob(<span class="pl-s"><span class="pl-pds">"</span>thumbnails<span class="pl-pds">"</span></span>, fileName, thumbnailContent, metadata);	
            }
            <span class="pl-k">catch</span> (<span class="pl-smi">Exception</span> e) {
                e<span class="pl-k">.</span>printStackTrace();
            }
        }
	    
        response<span class="pl-k">.</span>getWriter()<span class="pl-k">.</span>append(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>);
    }

    <span class="pl-c"><span class="pl-c">//</span> Utility method for storing blobs on Azure</span>
    <span class="pl-k">private</span> <span class="pl-smi">CloudBlockBlob</span> <span class="pl-en">uploadBlob</span>(<span class="pl-smi">String</span> <span class="pl-v">containerName</span>, <span class="pl-smi">String</span> <span class="pl-v">fileName</span>, <span class="pl-smi">InputStream</span> <span class="pl-v">blobData</span>, <span class="pl-k">HashMap&lt;<span class="pl-smi">String</span>,<span class="pl-smi">String</span>&gt;</span> <span class="pl-v">metadata</span>) {
        <span class="pl-k">try</span>  {
            <span class="pl-smi">CloudBlobContainer</span> container <span class="pl-k">=</span> getContainer(containerName);
            <span class="pl-smi">CloudBlockBlob</span> blob <span class="pl-k">=</span> container<span class="pl-k">.</span>getBlockBlobReference(fileName);
            blob<span class="pl-k">.</span>upload(blobData, blobData<span class="pl-k">.</span>available());

            <span class="pl-k">if</span> (metadata <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
                blob<span class="pl-k">.</span>setMetadata(metadata);
                blob<span class="pl-k">.</span>uploadMetadata();				
            }
            <span class="pl-k">return</span> blob;
        }
        <span class="pl-k">catch</span>(<span class="pl-smi">Exception</span> e) {
            <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    }
	
    <span class="pl-c"><span class="pl-c">//</span> Helper method to extract file names</span>
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-smi">String</span> <span class="pl-en">getSubmittedFileName</span>(<span class="pl-smi">Part</span> <span class="pl-v">part</span>) {
        <span class="pl-k">for</span> (<span class="pl-smi">String</span> cd <span class="pl-k">:</span> part<span class="pl-k">.</span>getHeader(<span class="pl-s"><span class="pl-pds">"</span>content-disposition<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>split(<span class="pl-s"><span class="pl-pds">"</span>;<span class="pl-pds">"</span></span>)) {
            <span class="pl-k">if</span> (cd<span class="pl-k">.</span>trim()<span class="pl-k">.</span>startsWith(<span class="pl-s"><span class="pl-pds">"</span>filename<span class="pl-pds">"</span></span>)) {
                <span class="pl-smi">String</span> fileName <span class="pl-k">=</span> cd<span class="pl-k">.</span>substring(cd<span class="pl-k">.</span>indexOf(<span class="pl-s"><span class="pl-pds">'</span>=<span class="pl-pds">'</span></span>) <span class="pl-k">+</span> <span class="pl-c1">1</span>)<span class="pl-k">.</span>trim()<span class="pl-k">.</span>replace(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\"</span><span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>);
                <span class="pl-k">return</span> fileName<span class="pl-k">.</span>substring(fileName<span class="pl-k">.</span>lastIndexOf(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>) <span class="pl-k">+</span> <span class="pl-c1">1</span>)<span class="pl-k">.</span>substring(fileName<span class="pl-k">.</span>lastIndexOf(<span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span>) <span class="pl-k">+</span> <span class="pl-c1">1</span>); <span class="pl-c"><span class="pl-c">//</span> MSIE fix.</span>
            }
        }
        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }
	
    <span class="pl-c"><span class="pl-c">//</span> Helper method to get blob containers</span>
    <span class="pl-k">private</span> <span class="pl-smi">CloudBlobContainer</span> <span class="pl-en">getContainer</span>(<span class="pl-smi">String</span> <span class="pl-v">containerName</span>) {
        <span class="pl-k">try</span> {
            <span class="pl-smi">CloudStorageAccount</span> account <span class="pl-k">=</span> <span class="pl-smi">CloudStorageAccount</span><span class="pl-k">.</span>parse(connectionString);
            <span class="pl-smi">CloudBlobClient</span> serviceClient <span class="pl-k">=</span> account<span class="pl-k">.</span>createCloudBlobClient();
            <span class="pl-k">return</span> serviceClient<span class="pl-k">.</span>getContainerReference(containerName);
        }
        <span class="pl-k">catch</span> (<span class="pl-smi">Exception</span> e) {
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>print(<span class="pl-s"><span class="pl-pds">"</span>Exception encountered: <span class="pl-pds">"</span></span>);
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(e<span class="pl-k">.</span>getMessage());
        }
        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }
	
    <span class="pl-c"><span class="pl-c">//</span> Helper method to scale an image	</span>
    <span class="pl-k">private</span> <span class="pl-smi">BufferedImage</span> <span class="pl-en">scale</span>(<span class="pl-smi">BufferedImage</span> <span class="pl-v">source</span>, <span class="pl-k">double</span> <span class="pl-v">ratio</span>) {
        <span class="pl-k">int</span> w <span class="pl-k">=</span> (<span class="pl-k">int</span>) (source<span class="pl-k">.</span>getWidth() <span class="pl-k">*</span> ratio);
        <span class="pl-k">int</span> h <span class="pl-k">=</span> (<span class="pl-k">int</span>) (source<span class="pl-k">.</span>getHeight() <span class="pl-k">*</span> ratio);
        <span class="pl-smi">BufferedImage</span> bi <span class="pl-k">=</span> getCompatibleImage(w, h);
        <span class="pl-smi">Graphics2D</span> g2d <span class="pl-k">=</span> bi<span class="pl-k">.</span>createGraphics();
        <span class="pl-k">double</span> xScale <span class="pl-k">=</span> (<span class="pl-k">double</span>) w <span class="pl-k">/</span> source<span class="pl-k">.</span>getWidth();
        <span class="pl-k">double</span> yScale <span class="pl-k">=</span> (<span class="pl-k">double</span>) h <span class="pl-k">/</span> source<span class="pl-k">.</span>getHeight();
        <span class="pl-smi">AffineTransform</span> at <span class="pl-k">=</span> <span class="pl-smi">AffineTransform</span><span class="pl-k">.</span>getScaleInstance(xScale,yScale);
        g2d<span class="pl-k">.</span>drawRenderedImage(source, at);
        g2d<span class="pl-k">.</span>dispose();
        <span class="pl-k">return</span> bi;
    }

    <span class="pl-k">private</span> <span class="pl-smi">BufferedImage</span> <span class="pl-en">getCompatibleImage</span>(<span class="pl-k">int</span> <span class="pl-v">w</span>, <span class="pl-k">int</span> <span class="pl-v">h</span>) 
    {
        <span class="pl-smi">GraphicsEnvironment</span> ge <span class="pl-k">=</span> <span class="pl-smi">GraphicsEnvironment</span><span class="pl-k">.</span>getLocalGraphicsEnvironment();
        <span class="pl-smi">GraphicsDevice</span> gd <span class="pl-k">=</span> ge<span class="pl-k">.</span>getDefaultScreenDevice();
        <span class="pl-smi">GraphicsConfiguration</span> gc <span class="pl-k">=</span> gd<span class="pl-k">.</span>getDefaultConfiguration();
        <span class="pl-smi">BufferedImage</span> image <span class="pl-k">=</span> gc<span class="pl-k">.</span>createCompatibleImage(w, h);
        <span class="pl-k">return</span> image;
    }
	
    <span class="pl-c"><span class="pl-c">//</span> Utility method for handling requests to the Computer Vision API</span>
    <span class="pl-k">private</span> <span class="pl-smi">String</span> <span class="pl-en">analyzeImage</span>(<span class="pl-smi">String</span> <span class="pl-v">blobUrl</span>) <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-smi">URL</span> obj <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">URL</span>(visionEndpoint <span class="pl-k">+</span>  <span class="pl-s"><span class="pl-pds">"</span>/analyze?visualFeatures=description<span class="pl-pds">"</span></span>);
        <span class="pl-smi">HttpURLConnection</span> con <span class="pl-k">=</span> (<span class="pl-smi">HttpURLConnection</span>) obj<span class="pl-k">.</span>openConnection();
        con<span class="pl-k">.</span>setRequestMethod(<span class="pl-s"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>);

        <span class="pl-c"><span class="pl-c">//</span> add request header</span>
        con<span class="pl-k">.</span>setRequestProperty(<span class="pl-s"><span class="pl-pds">"</span>Ocp-Apim-Subscription-Key<span class="pl-pds">"</span></span>, visionAPIKey);
        con<span class="pl-k">.</span>setRequestProperty(<span class="pl-s"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>application/json<span class="pl-pds">"</span></span>);
		
        con<span class="pl-k">.</span>setUseCaches (<span class="pl-c1">false</span>);
        con<span class="pl-k">.</span>setDoInput(<span class="pl-c1">true</span>);
        con<span class="pl-k">.</span>setDoOutput(<span class="pl-c1">true</span>);
		
        <span class="pl-c"><span class="pl-c">//</span> prepare the HTTP POST body</span>
        <span class="pl-smi">JSONObject</span> url <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JSONObject</span>();
        url<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>url<span class="pl-pds">"</span></span>, blobUrl);
		
        con<span class="pl-k">.</span>setDoOutput(<span class="pl-c1">true</span>);
        <span class="pl-smi">DataOutputStream</span> wr <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">DataOutputStream</span>(con<span class="pl-k">.</span>getOutputStream());
        wr<span class="pl-k">.</span>writeBytes(url<span class="pl-k">.</span>toString());
        wr<span class="pl-k">.</span>flush();
        wr<span class="pl-k">.</span>close();
		
        <span class="pl-k">int</span> responseCode <span class="pl-k">=</span> con<span class="pl-k">.</span>getResponseCode();
        <span class="pl-smi">BufferedReader</span> in <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">BufferedReader</span>(<span class="pl-k">new</span> <span class="pl-smi">InputStreamReader</span>(con<span class="pl-k">.</span>getInputStream()));
        <span class="pl-smi">String</span> inputLine;
        <span class="pl-smi">StringBuffer</span> response <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">StringBuffer</span>();

        <span class="pl-c"><span class="pl-c">//</span> read the response as a string</span>
        <span class="pl-k">while</span> ((inputLine <span class="pl-k">=</span> in<span class="pl-k">.</span>readLine()) <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            response<span class="pl-k">.</span>append(inputLine);
        }

        in<span class="pl-k">.</span>close();
        <span class="pl-k">return</span> response<span class="pl-k">.</span>toString();
    }
}</pre></div>
</li>
<li>
<p>On line 36, replace <em>connection_string</em> with the connection string that you saved in Exercise 1, Step 10.</p>
</li>
<li>
<p>On line 37, replace <em>vision_api_key</em> with the Computer Vision API key that you saved in Exercise 3, Step 5.</p>
</li>
<li>
<p>On line 38, replace <em>vision_api_endpoint</em> with the Computer Vision API endpoint that you saved in Exercise 3, Step 4.</p>
</li>
<li>
<p>Right-click <strong>WebContent</strong> in Project Explorer and use the <strong>New</strong> &gt; <strong>HTML file</strong> command to add an HTML file named "index.html" to the project.</p>
</li>
<li>
<p>Replace the contents of <strong>index.html</strong> with the statements below. Then save the modified file.</p>
<div class="highlight highlight-text-html-basic"><pre>&lt;!DOCTYPE html&gt;
&lt;<span class="pl-ent">html</span>&gt;
&lt;<span class="pl-ent">head</span>&gt;
&lt;<span class="pl-ent">meta</span> <span class="pl-e">charset</span>=<span class="pl-s"><span class="pl-pds">"</span>ISO-8859-1<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">title</span>&gt;Intellipix&lt;/<span class="pl-ent">title</span>&gt;
&lt;/<span class="pl-ent">head</span>&gt;
&lt;<span class="pl-ent">body</span> <span class="pl-e">onload</span>=<span class="pl-s"><span class="pl-pds">"</span>searchPics()<span class="pl-pds">"</span></span>&gt;

&lt;<span class="pl-ent">style</span>&gt;<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-ent">body</span> {</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">background-color</span></span>:<span class="pl-c1">#444</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">color</span></span>:<span class="pl-c1">#FFF</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">font-family</span></span>:<span class="pl-c1">tahoma</span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-ent">input</span> {</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">background-color</span></span>:<span class="pl-c1">#555</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">border</span></span>:<span class="pl-c1">1<span class="pl-k">px</span></span> <span class="pl-c1">solid</span> <span class="pl-c1">#666</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">color</span></span>:<span class="pl-c1">#fff</span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-e">#modal</span>{</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">max-height</span></span>: <span class="pl-c1">calc</span>(<span class="pl-c1">100<span class="pl-k">%</span></span> <span class="pl-k">-</span> <span class="pl-c1">100<span class="pl-k">px</span></span>);</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">position</span></span>: <span class="pl-c1">fixed</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">top</span></span>: <span class="pl-c1">50<span class="pl-k">%</span></span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">left</span></span>: <span class="pl-c1">50<span class="pl-k">%</span></span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">transform</span></span>: <span class="pl-c1">translate</span>(<span class="pl-c1">-50<span class="pl-k">%</span></span>, <span class="pl-c1">-50<span class="pl-k">%</span></span>);</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">display</span></span>:<span class="pl-c1">none</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">background-color</span></span>:<span class="pl-c1">#555</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">border</span></span>:<span class="pl-c1">1<span class="pl-k">px</span></span> <span class="pl-c1">solid</span> <span class="pl-c1">#666</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">padding</span></span>:<span class="pl-c1">3<span class="pl-k">px</span></span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">text-align</span></span>:<span class="pl-c1">center</span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-e">#modalimage</span>{</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">max-height</span></span>: <span class="pl-c1">calc</span>(<span class="pl-c1">100<span class="pl-k">%</span></span> <span class="pl-k">-</span> <span class="pl-c1">100<span class="pl-k">px</span></span>);</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">max-width</span></span>: <span class="pl-c1">100<span class="pl-k">%</span></span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-e">#controls</span>{</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">background-color</span></span>:<span class="pl-c1">#555</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">border</span></span>:<span class="pl-c1">1<span class="pl-k">px</span></span> <span class="pl-c1">solid</span> <span class="pl-c1">#666</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">padding</span></span>:<span class="pl-c1">5<span class="pl-k">px</span></span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-e">#gallery</span> <span class="pl-ent">span</span> {</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">display</span></span>:<span class="pl-c1">inline-block</span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-e">#gallery</span> <span class="pl-ent">img</span> {</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">border</span></span>:<span class="pl-c1">1<span class="pl-k">px</span></span> <span class="pl-c1">solid</span> <span class="pl-c1">#000</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">padding</span></span>:<span class="pl-c1">5<span class="pl-k">px</span></span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">background-color</span></span>:<span class="pl-c1">#fff</span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">margin</span></span>:<span class="pl-c1">3<span class="pl-k">px</span></span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-e">#search</span> {</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">width</span></span>:<span class="pl-c1">45<span class="pl-k">%</span></span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">float</span></span>:<span class="pl-c1">left</span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-e">#upload</span> {</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">width</span></span>:<span class="pl-c1">45<span class="pl-k">%</span></span>;</span>
<span class="pl-s1">    <span class="pl-c1"><span class="pl-c1">margin-left</span></span>:<span class="pl-c1">45<span class="pl-k">%</span></span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span><span class="pl-s1">&lt;</span>/<span class="pl-ent">style</span>&gt;

&lt;<span class="pl-ent">script</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>text/javascript<span class="pl-pds">"</span></span>&gt;<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">function</span> <span class="pl-en">uploadPics</span>() {</span>
<span class="pl-s1">    <span class="pl-k">var</span> form <span class="pl-k">=</span> <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(<span class="pl-s"><span class="pl-pds">'</span>uploader<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">    <span class="pl-k">var</span> message <span class="pl-k">=</span> <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(<span class="pl-s"><span class="pl-pds">'</span>uploadmessage<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">	</span>
<span class="pl-s1">    <span class="pl-smi">form</span>.<span class="pl-smi">enabled</span> <span class="pl-k">=</span> <span class="pl-c1">false</span>;</span>
<span class="pl-s1">    <span class="pl-smi">message</span>.<span class="pl-smi">innerHTML</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Uploading and Processing...<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-c"><span class="pl-c">//</span> get file references from the form and then uploads the files</span></span>
<span class="pl-s1">    <span class="pl-k">var</span> formData <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">FormData</span>();</span>
<span class="pl-s1">    <span class="pl-k">var</span> fileSelect <span class="pl-k">=</span> <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(<span class="pl-s"><span class="pl-pds">'</span>file-select<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">    <span class="pl-k">var</span> files <span class="pl-k">=</span> <span class="pl-smi">fileSelect</span>.<span class="pl-smi">files</span>;</span>
<span class="pl-s1">	</span>
<span class="pl-s1">    <span class="pl-k">for</span> (<span class="pl-k">var</span> i <span class="pl-k">=</span> <span class="pl-c1">0</span>; i <span class="pl-k">&lt;</span> <span class="pl-smi">files</span>.<span class="pl-c1">length</span>; i<span class="pl-k">++</span>) {</span>
<span class="pl-s1">        <span class="pl-k">var</span> file <span class="pl-k">=</span> files[i];</span>
<span class="pl-s1">        <span class="pl-smi">formData</span>.<span class="pl-c1">append</span>(<span class="pl-s"><span class="pl-pds">'</span>photos<span class="pl-pds">'</span></span>, file, <span class="pl-smi">file</span>.<span class="pl-c1">name</span>);</span>
<span class="pl-s1">    }		</span>
<span class="pl-s1">	</span>
<span class="pl-s1">    <span class="pl-c"><span class="pl-c">//</span> pure AJAX; no jQuery</span></span>
<span class="pl-s1">    <span class="pl-k">var</span> xhr <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">XMLHttpRequest</span>();</span>
<span class="pl-s1">    <span class="pl-smi">xhr</span>.<span class="pl-c1">open</span>(<span class="pl-s"><span class="pl-pds">'</span>POST<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>api<span class="pl-pds">'</span></span>, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">    <span class="pl-smi">xhr</span>.<span class="pl-en">onload</span> <span class="pl-k">=</span> <span class="pl-k">function</span> () {</span>
<span class="pl-s1">        <span class="pl-k">if</span> (<span class="pl-smi">xhr</span>.<span class="pl-c1">status</span> <span class="pl-k">===</span> <span class="pl-c1">200</span>) {</span>
<span class="pl-s1">            <span class="pl-smi">message</span>.<span class="pl-smi">innerHTML</span> <span class="pl-k">=</span> (<span class="pl-smi">files</span>.<span class="pl-c1">length</span>) <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span> file(s) uploaded.<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">            <span class="pl-en">reset</span>();</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">        <span class="pl-k">else</span> {</span>
<span class="pl-s1">            <span class="pl-smi">message</span>.<span class="pl-smi">innerHTML</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>An error occurred!<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">        <span class="pl-smi">form</span>.<span class="pl-c1">reset</span>();</span>
<span class="pl-s1">    };</span>
<span class="pl-s1">    <span class="pl-smi">xhr</span>.<span class="pl-c1">send</span>(formData);</span>
<span class="pl-s1">}</span>
<span class="pl-s1">	</span>
<span class="pl-s1"><span class="pl-k">function</span> <span class="pl-en">searchPics</span>(<span class="pl-smi">search</span>) {</span>
<span class="pl-s1">    <span class="pl-k">var</span> xhr <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">XMLHttpRequest</span>();</span>
<span class="pl-s1">    <span class="pl-k">var</span> url <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>api<span class="pl-pds">"</span></span></span>
<span class="pl-s1">	</span>
<span class="pl-s1">    <span class="pl-k">if</span> (search <span class="pl-k">&amp;&amp;</span> search <span class="pl-k">!=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>){</span>
<span class="pl-s1">        url <span class="pl-k">+=</span> <span class="pl-s"><span class="pl-pds">"</span>?search=<span class="pl-pds">"</span></span> <span class="pl-k">+</span> search;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">	</span>
<span class="pl-s1">    <span class="pl-smi">xhr</span>.<span class="pl-c1">open</span>(<span class="pl-s"><span class="pl-pds">'</span>GET<span class="pl-pds">'</span></span>, url, <span class="pl-c1">true</span>);</span>
<span class="pl-s1">    <span class="pl-smi">xhr</span>.<span class="pl-en">onload</span> <span class="pl-k">=</span> <span class="pl-k">function</span> () {</span>
<span class="pl-s1">        <span class="pl-k">if</span> (<span class="pl-smi">xhr</span>.<span class="pl-c1">status</span> <span class="pl-k">===</span> <span class="pl-c1">200</span>) {</span>
<span class="pl-s1">            htmlStr <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">            <span class="pl-k">var</span> images <span class="pl-k">=</span> <span class="pl-c1">JSON</span>.<span class="pl-c1">parse</span>(<span class="pl-smi">xhr</span>.<span class="pl-c1">responseText</span>);</span>
<span class="pl-s1">			</span>
<span class="pl-s1">            <span class="pl-c"><span class="pl-c">//</span> create HTML from JSON data and append it to the DOM</span></span>
<span class="pl-s1">            <span class="pl-k">for</span> (<span class="pl-k">var</span> i <span class="pl-k">=</span> <span class="pl-c1">0</span>; i <span class="pl-k">&lt;</span> <span class="pl-smi">images</span>.<span class="pl-c1">length</span>; i<span class="pl-k">++</span>) {</span>
<span class="pl-s1">                <span class="pl-k">var</span> image <span class="pl-k">=</span> images[i];</span>
<span class="pl-s1">                htmlStr <span class="pl-k">+=</span> <span class="pl-s"><span class="pl-pds">"</span>&lt;span class='imgwrapper'&gt;&lt;img onclick='showImage(<span class="pl-cce">\"</span><span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-smi">image</span>.<span class="pl-smi">fullUrl</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\"</span>, <span class="pl-cce">\"</span><span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-smi">image</span>.<span class="pl-smi">metadata</span>.<span class="pl-c1">caption</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\"</span>)' src='<span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-smi">image</span>.<span class="pl-smi">url</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>' title='<span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-smi">image</span>.<span class="pl-smi">metadata</span>.<span class="pl-c1">caption</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>' alt='<span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-smi">image</span>.<span class="pl-smi">metadata</span>.<span class="pl-c1">caption</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>'&gt;&lt;/span&gt;<span class="pl-pds">"</span></span></span>
<span class="pl-s1">            }</span>
<span class="pl-s1">			</span>
<span class="pl-s1">            <span class="pl-k">if</span> (htmlStr <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>) {</span>
<span class="pl-s1">                htmlStr <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>No images found.<span class="pl-pds">"</span></span></span>
<span class="pl-s1">            }</span>
<span class="pl-s1">			</span>
<span class="pl-s1">            <span class="pl-k">var</span> gallery <span class="pl-k">=</span> <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(<span class="pl-s"><span class="pl-pds">"</span>gallery<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1">            <span class="pl-smi">gallery</span>.<span class="pl-smi">innerHTML</span> <span class="pl-k">=</span> htmlStr;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">        <span class="pl-k">else</span> {</span>
<span class="pl-s1">            <span class="pl-smi">gallery</span>.<span class="pl-smi">innerHTML</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>An error occurred!<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">    };</span>
<span class="pl-s1">    <span class="pl-smi">xhr</span>.<span class="pl-c1">send</span>();</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> resets the search form</span></span>
<span class="pl-s1"><span class="pl-k">function</span> <span class="pl-en">reset</span>(){</span>
<span class="pl-s1">    <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(<span class="pl-s"><span class="pl-pds">'</span>searchTerm<span class="pl-pds">'</span></span>).<span class="pl-c1">value</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">    <span class="pl-en">searchPics</span>();</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> shows the modal dialog for an image</span></span>
<span class="pl-s1"><span class="pl-k">function</span> <span class="pl-en">showImage</span>(<span class="pl-smi">url</span>, <span class="pl-smi">caption</span>){</span>
<span class="pl-s1">    <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(<span class="pl-s"><span class="pl-pds">'</span>modalimage<span class="pl-pds">'</span></span>).<span class="pl-smi">src</span> <span class="pl-k">=</span> url;</span>
<span class="pl-s1">    <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(<span class="pl-s"><span class="pl-pds">'</span>modaltext<span class="pl-pds">'</span></span>).<span class="pl-smi">innerHTML</span> <span class="pl-k">=</span> caption;</span>
<span class="pl-s1">    <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(<span class="pl-s"><span class="pl-pds">'</span>modal<span class="pl-pds">'</span></span>).<span class="pl-c1">style</span>.<span class="pl-c1">display</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>block<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> closes the modal dialog</span></span>
<span class="pl-s1"><span class="pl-k">function</span> <span class="pl-en">closeImage</span>(){</span>
<span class="pl-s1">    <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(<span class="pl-s"><span class="pl-pds">'</span>modal<span class="pl-pds">'</span></span>).<span class="pl-c1">style</span>.<span class="pl-c1">display</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>none<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span><span class="pl-s1">&lt;</span>/<span class="pl-ent">script</span>&gt;

&lt;<span class="pl-ent">h1</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>title<span class="pl-pds">"</span></span>&gt;Intellipix&lt;/<span class="pl-ent">h1</span>&gt;

&lt;<span class="pl-ent">div</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>controls<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">div</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>search<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">div</span>&gt;Search&lt;/<span class="pl-ent">div</span>&gt;
&lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>searchTerm<span class="pl-pds">"</span></span> <span class="pl-e">placeholder</span>=<span class="pl-s"><span class="pl-pds">"</span>Enter a search term<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>button<span class="pl-pds">"</span></span> <span class="pl-e">onclick</span>=<span class="pl-s"><span class="pl-pds">"</span>searchPics(document.getElementById('searchTerm').value)<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span>Search<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>button<span class="pl-pds">"</span></span> <span class="pl-e">onclick</span>=<span class="pl-s"><span class="pl-pds">"</span>reset()<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span>Reset Search<span class="pl-pds">"</span></span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;

&lt;<span class="pl-ent">div</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>upload<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">form</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>uploader<span class="pl-pds">"</span></span> &gt;
&lt;<span class="pl-ent">div</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>uploadmessage<span class="pl-pds">"</span></span>&gt;Select image to upload:&lt;/<span class="pl-ent">div</span>&gt;
&lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>file<span class="pl-pds">"</span></span> <span class="pl-e">name</span>=<span class="pl-s"><span class="pl-pds">"</span>file-select<span class="pl-pds">"</span></span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>file-select<span class="pl-pds">"</span></span> <span class="pl-e">multiple</span>&gt;
&lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>button<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span>Upload<span class="pl-pds">"</span></span> <span class="pl-e">onclick</span>=<span class="pl-s"><span class="pl-pds">"</span>uploadPics()<span class="pl-pds">"</span></span>&gt;
&lt;/<span class="pl-ent">form</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;
&lt;<span class="pl-ent">div</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>message<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">div</span>&gt;

&lt;<span class="pl-ent">div</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>gallery<span class="pl-pds">"</span></span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;

&lt;<span class="pl-ent">div</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>modal<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">img</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>modalimage<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">p</span> <span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>modaltext<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">p</span>&gt;
&lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>button<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span>close<span class="pl-pds">"</span></span> <span class="pl-e">onclick</span>=<span class="pl-s"><span class="pl-pds">"</span>closeImage()<span class="pl-pds">"</span></span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;

&lt;/<span class="pl-ent">body</span>&gt;
&lt;/<span class="pl-ent">html</span>&gt;</pre></div>
</li>
</ol>
<p>With the app complete, the next step is to run it locally and make sure it works as intended before deploying it to Azure.</p>
<p><a name="Exercise6"></a></p>
<h2>Exercise 6: Test the app locally</h2>
<p>Eclipse supports many popular servers for running Web sites written in Java, including <a href="http://tomcat.apache.org/" rel="nofollow">Apache Tomcat</a>. Tomcat provides the hooks needed to run servlets and is also capable of serving up static content such as HTML. Moreover, Azure can use Tomcat to host Java apps. In this exercise, you will run the app in a local Tomcat server in order to test it and familiarize yourself with its features.</p>
<ol>
<li>
<p>Use the <strong>Run</strong> &gt; <strong>Debug</strong> command to launch the app in the debugger. In the "Debug As" dialog that opens, select <strong>Run on Server</strong>, and then click <strong>OK</strong>.</p>
<p><a href="Images/java-debug-as.png" target="_blank"><img src="Images/java-debug-as.png" alt="Launching the app in the debugger" style="max-width:100%;"></a></p>
<p><em>Launching the app in the debugger</em></p>
</li>
<li>
<p>In the "Debug on Server" dialog, select <strong>Choose an existing server</strong>, select <strong>Tomcat v7.0 Server at localhost</strong> as the server, and click <strong>Finish</strong>.</p>
</li>
<li>
<p>Wait for the app to appear in your browser, either inside or outside Eclipse. Then click the <strong>Browse...</strong> button, select all of the files in the "photos" folder of the <a href="https://a4r.blob.core.windows.net/public/cs-storage-resources.zip" rel="nofollow">resources that accompany this lab</a>, and click the <strong>Upload</strong> button to upload them to the Web site.</p>
<blockquote>
<p>Each image uploaded to the Web site is written to Azure blob storage and then passed to the Computer Vision API, which analyzes the image and returns a caption and a set of tags. Captions and tags are stored in blob metadata.</p>
</blockquote>
</li>
<li>
<p>Wait for the upload to complete. Then confirm that the uploaded images appear in the Web page. These are the thumbnails generated from the uploaded images. They are stored as blobs in the "thumbnails" container that you created in Exercise 1.</p>
<p><a href="Images/java-intellipix-0.png" target="_blank"><img src="Images/java-intellipix-0.png" alt="The uploaded images" style="max-width:100%;"></a></p>
<p><em>The uploaded images</em></p>
</li>
<li>
<p>Hover the cursor over one of the image thumbnails. Confirm that a tooltip window appears containing a caption for the image. <em>This is the caption that was generated by the Computer Vision API and stored in blob metadata</em>.</p>
<p><a href="Images/java-intellipix-1.png" target="_blank"><img src="Images/java-intellipix-1.png" alt="The computer-generated caption" style="max-width:100%;"></a></p>
<p><em>The computer-generated caption</em></p>
</li>
<li>
<p>Click an image and confirm that an enlarged version appears. This is the full-size image stored in blob storage in the "photos" container that you created in Exercise 1.</p>
<p><a href="Images/java-intellipix-2.png" target="_blank"><img src="Images/java-intellipix-2.png" alt="Enlarging an image" style="max-width:100%;"></a></p>
<p><em>Enlarging an image</em></p>
</li>
<li>
<p>Type a keyword describing something you see in the images â€” for example, "river" â€” into the search box. Search results will vary depending on what you typed and what images you uploaded. But the result should be a filtered list of images â€” images whose metadata keywords include all or part of the keyword that you typed.</p>
<p><a href="Images/java-intellipix-3.png" target="_blank"><img src="Images/java-intellipix-3.png" alt="Performing a search" style="max-width:100%;"></a></p>
<p><em>Performing a search</em></p>
</li>
<li>
<p>Do a <strong>View Source</strong> in your browser to view the source for the page. Find the <code>&lt;img&gt;</code> elements representing the image thumbnails. Observe that the URLs assigned to the images refer <strong>directly to blobs in blob storage</strong>. This is possible because you set the containers' <strong>Access type</strong> to <strong>Blob</strong>, which makes the blobs inside them publicly accessible.</p>
<blockquote>
<p>What would happen if the containers were private? If you're not sure, try it and see. Temporaily change the "thumbnails" container's <strong>Access type</strong> to <strong>Private</strong> in the Azure Portal. Then refresh the Intellipix page in your browser and see what happens.</p>
</blockquote>
</li>
<li>
<p>Return to the Microsoft Azure Storage Explorer (or restart if it you didn't leave it running) and click the "photos" container under the storage account you created in Exercise 1. The number of blobs in the container should equal the number of photos you uploaded. Double-click one of the blobs to download it and see the image stored in the blob.</p>
<p><a href="Images/node-photos-container.png" target="_blank"><img src="Images/node-photos-container.png" alt="Contents of the &quot;photos&quot; container" style="max-width:100%;"></a></p>
<p><em>Contents of the "photos" container</em></p>
</li>
<li>
<p>Open the "thumbnails" container in Storage Explorer. How many blobs do you see there? Open one of the blobs to see what's inside. These are the thumbnail images generated from the image uploads.</p>
</li>
<li>
<p>Want to see where the metadata generated by the Computer Vision API is being stored? Open the "photos" container again. Right-click any of the blobs in the container and select <strong>Properties</strong>. In the ensuing dialog, you'll see a list of the metadata attached to the blob. Each metadata item is a key-value pair. The computer-generated caption is stored in the item named "caption," while the keywords generated from the image are stored in a JSON string array named "tags."</p>
<p><a href="Images/node-blob-metadata.png" target="_blank"><img src="Images/node-blob-metadata.png" alt="Blob metadata" style="max-width:100%;"></a></p>
<p><em>Blob metadata</em></p>
<p>When you're finished, click <strong>Cancel</strong> to close the Properties dialog.</p>
</li>
<li>
<p>Did you know that the Azure Toolkit for Eclipse contains an Azure Explorer of its own? Use Eclipse's <strong>Windows</strong> &gt; <strong>Show View</strong> &gt; <strong>Other...</strong> command to list all the different views Eclipse supports, and select <strong>Azure Explorer</strong> from the "Azure" folder. When the Azure Explorer opens, find the storage account that you created in Exercise 1 and click any of the containers in it to view the blobs in that container. You can also use the Azure Explorer to manage Azure Web Apps, Docker hosts, virtual machines, and other Azure resources.</p>
<p><a href="Images/java-azure-explorer.png" target="_blank"><img src="Images/java-azure-explorer.png" alt="Viewing blob storage with the Azure Explorer" style="max-width:100%;"></a></p>
<p><em>Viewing blob storage with the Azure Explorer</em></p>
</li>
</ol>
<p>You're almost finished, but the final and most important step remains. It is time to deploy the app to the cloud.</p>
<p><a name="Exercise7"></a></p>
<h2>Exercise 7: Deploy the app to Azure</h2>
<p>The Azure Toolkit for Eclipse has integrated support for deploying Dynamic Web Site projects to Azure as <a href="https://docs.microsoft.com/en-us/azure/app-service-web/app-service-web-overview" rel="nofollow">Azure Web Apps</a>. In this exercise, you will use the Azure Toolkit to deploy Intellipix to Azure.</p>
<ol>
<li>
<p>Right-click the Intellipix project in Project Explorer and select <strong>Azure</strong> &gt; <strong>Publish as Azure Web App</strong> from the context menu.</p>
</li>
<li>
<p>Make sure <strong>Interactive</strong> is selected as the authentication method, and click <strong>Sign in</strong>. When prompted, sign in with your Microsoft account.</p>
<p><a href="Images/java-sign-in.png" target="_blank"><img src="Images/java-sign-in.png" alt="Signing in to Azure" style="max-width:100%;"></a></p>
<p><em>Signing in to Azure</em></p>
</li>
<li>
<p>Next, select the Azure subscription that you want to use for the Azure Web App, and click <strong>Select</strong>.</p>
</li>
<li>
<p>In the "Deploy Web App" dialog, click the <strong>Create</strong> button to create a new Azure App Service.</p>
<blockquote>
<p>Azure App Service is the family of services that Azure Web Apps belong to. Other types of Azure App Services include Azure API Apps and Azure Logic Apps.</p>
</blockquote>
</li>
<li>
<p>In the "Create App Service" dialog, select <strong>Create new</strong>. Set <strong>Location</strong> to the same location that you selected for the storage account in Exercise 1. Select <strong>Free_F1</strong> for the <strong>Pricing tier</strong>, but <em>do not</em> click the <strong>Create</strong> button just yet.</p>
<p><a href="Images/java-create-app-service-1.png" target="_blank"><img src="Images/java-create-app-service-1.png" alt="Creating an Azure App Service" style="max-width:100%;"></a></p>
<p><em>Creating an Azure App Service</em></p>
</li>
<li>
<p>Click the <strong>Resource group</strong> tab, select <strong>Use existing</strong>, and select the resource group that you created in Exercise 1. Then click the <strong>Create</strong> button. This will place the Azure Web App in the same resource group as the storage account and other resources you created in this lab so they can be managed as a unit.</p>
<p><a href="Images/java-create-app-service-2.png" target="_blank"><img src="Images/java-create-app-service-2.png" alt="Specifying the resource group" style="max-width:100%;"></a></p>
<p><em>Specifying the resource group</em></p>
</li>
<li>
<p>In the "Deploy Web App" dialog, copy the Web site URL to the clipboard. Then check the <strong>Deploy to root</strong> box and click <strong>Deploy</strong>.</p>
<p><a href="Images/java-deploy-web-app.png" target="_blank"><img src="Images/java-deploy-web-app.png" alt="Deploying the Web app" style="max-width:100%;"></a></p>
<p><em>Deploying the Web app</em></p>
</li>
<li>
<p>Wait until Eclipse indicates that the app has been published. Then open a browser and paste the URL that is on the clipboard into the browser's address bar. Confirm that Intellipix appears as before, but this time hosted in Azure.</p>
<p><a href="Images/java-intellipix-on-azure.png" target="_blank"><img src="Images/java-intellipix-on-azure.png" alt="The finished product!" style="max-width:100%;"></a></p>
<p><em>The finished product!</em></p>
</li>
</ol>
<p>If you make changes to the app and want to push the changes out to the Web, simply deploy it again from Eclipse. Of course, you can still test your changes locally before publishing to the Web.</p>
<p><a name="Summary"></a></p>
<h2>Summary</h2>
<p>When you're finished using the site, you should delete the resource group containing it. Deleting the resource group deletes all of the resources inside it (including the storage account, the blobs uploaded to it, and the Azure Web App), removes all traces of this lab from your account, and prevents any further charges from being incurred for it. To delete the resource group, simply open the resource-group blade in the portal and click <strong>Delete resource group</strong> at the top of the blade. You will be asked to type the resource group's name to confirm that you want to delete it, because once deleted, a resource group can't be recovered.</p>
<p>There is much more that you could do to develop Intellipix and to leverage Azure even further. For example, you could add support for authenticating users and deleting photos, and rather than force the user to wait for Cognitive Services to process a photo following an upload, you could use <a href="https://azure.microsoft.com/en-us/services/functions/" rel="nofollow">Azure Functions</a> to call the Computer Vision API asynchronously each time an image is added to blob storage. You could even use Cognitive Services to detect faces in the photos and analyze the emotions depicted by those faces. With the cloud as your platform, the sky is the limit (pun intended).</p>
<hr>
<p>Copyright 2017 Microsoft Corporation. All rights reserved. Except where otherwise noted, these materials are licensed under the terms of the MIT License. You may use them according to the license as is most appropriate for your project. The terms of this license can be found at <a href="https://opensource.org/licenses/MIT" rel="nofollow">https://opensource.org/licenses/MIT</a>.</p>
</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
